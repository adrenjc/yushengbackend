# 生产环境部署指南

## 🚀 上线前数据清理

在生产环境上线前，需要清除所有测试数据，确保系统以干净的状态启动。

## ⚠️ 重要警告

**数据清理是不可逆的操作！请务必：**
1. 📋 确认这是生产环境部署
2. 💾 完成数据备份
3. 🔍 仔细检查清理范围
4. ✅ 获得相关人员确认

## 📊 清理范围

### 将被删除的数据：
- ✂️ 所有商品模板
- ✂️ 所有商品档案数据
- ✂️ 所有匹配任务和记录
- ✂️ 所有上传的文件

### 将被保留的数据：
- ✅ 用户账户信息
- ✅ 系统配置数据
- ✅ 日志文件

## 🛠️ 操作步骤

### 第一步：数据备份（必须）

```bash
# 进入后端目录
cd yushengbackend

# 执行数据备份
node scripts/backup-data.js
```

备份文件将保存在 `backups/backup-[timestamp]/` 目录中，包含：
- `templates.json` - 模板数据
- `products.json` - 商品数据
- `matching-tasks.json` - 匹配任务
- `matching-records.json` - 匹配记录
- `users.json` - 用户数据
- `uploads/` - 上传文件
- `restore.js` - 自动生成的恢复脚本

### 第二步：执行清理

```bash
# 执行生产环境清理脚本
node scripts/production-cleanup.js
```

### 第三步：安全确认

脚本将要求您进行以下确认：

1. **环境确认**
   ```
   输入: production
   ```

2. **备份确认**
   ```
   输入: backed-up
   ```

3. **最终确认**
   ```
   输入: [随机生成的6位确认码]
   ```

### 第四步：验证清理结果

清理完成后，脚本将显示详细的清理统计：

```
📊 清理结果:
   ✓ 匹配记录: 1250/1250
   ✓ 匹配任务: 45/45
   ✓ 商品数据: 8932/8932
   ✓ 商品模板: 12/12
   ✓ 上传文件: 已清理
   ✓ 用户数据: 已保留
```

## 🔄 数据恢复（紧急情况）

如果需要恢复数据，可以使用备份：

```bash
# 进入备份目录
cd backups/backup-[timestamp]/

# 执行恢复脚本
node restore.js
```

## 📝 清理日志

建议将清理过程的输出保存到日志文件：

```bash
# 带日志记录的清理
node scripts/production-cleanup.js 2>&1 | tee production-cleanup.log
```

## 🎯 上线后验证

清理完成后，请验证以下功能：

### 1. 用户登录
- [ ] 管理员账户可正常登录
- [ ] 用户权限功能正常

### 2. 模板管理
- [ ] 可以创建新模板
- [ ] 模板列表为空（清理成功）

### 3. 商品管理
- [ ] 可以导入商品数据
- [ ] 商品列表为空（清理成功）

### 4. 匹配功能
- [ ] 可以创建匹配任务
- [ ] 匹配记录为空（清理成功）

### 5. 文件上传
- [ ] 可以正常上传文件
- [ ] uploads目录为空（清理成功）

## 🚨 故障排除

### 问题1：数据库连接失败
```bash
# 检查MongoDB服务状态
sudo systemctl status mongod

# 检查配置文件
cat src/config/env.js
```

### 问题2：权限不足
```bash
# 确保有足够的文件系统权限
sudo chown -R $(whoami) uploads/
sudo chown -R $(whoami) backups/
```

### 问题3：清理不完整
```bash
# 手动检查数据库
mongo
use yusheng_production
db.products.count()
db.producttemplates.count()
db.matchingtasks.count()
db.matchingrecords.count()
```

## 📞 支持联系

如果在清理过程中遇到问题：

1. 📧 **停止操作** - 立即停止清理脚本
2. 💾 **保留日志** - 保存所有错误信息
3. 🔄 **准备恢复** - 确保备份文件完整
4. 📞 **联系技术支持** - 提供详细的错误信息

## ✅ 清理检查清单

上线前请确认完成以下检查：

- [ ] 已完成数据备份
- [ ] 确认当前为生产环境
- [ ] 获得相关人员授权
- [ ] 服务器资源充足
- [ ] 网络连接稳定
- [ ] 准备好回滚方案

---

**🎉 祝您上线成功！**
