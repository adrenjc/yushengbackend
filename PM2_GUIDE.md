# PM2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨å•ä¸€çš„ PM2 é…ç½®æ–‡ä»¶ `ecosystem.config.js`ï¼Œä¸“é—¨é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ã€‚æœ¬åœ°å¼€å‘ä½¿ç”¨ `npm run dev` å³å¯ã€‚

## ğŸš€ ç‰¹æ€§

### æ€§èƒ½ä¼˜åŒ–

- **é›†ç¾¤æ¨¡å¼**: è‡ªåŠ¨ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
- **å†…å­˜ç®¡ç†**: 2GB å†…å­˜é™åˆ¶ï¼Œè‡ªåŠ¨é‡å¯
- **GC ä¼˜åŒ–**: ä¼˜åŒ–åƒåœ¾å›æ”¶ç­–ç•¥
- **è´Ÿè½½å‡è¡¡**: è‡ªåŠ¨ç«¯å£åˆ†é…

### å¯é æ€§ä¿éšœ

- **ä¼˜é›…é‡å¯**: æ”¯æŒé›¶åœæœºé‡å¯
- **å¥åº·æ£€æŸ¥**: HTTP å¥åº·æ£€æŸ¥
- **æŒ‡æ•°é€€é¿**: æ™ºèƒ½é‡å¯ç­–ç•¥
- **æ—¥å¿—è½®è½¬**: è‡ªåŠ¨ç®¡ç†æ—¥å¿—æ–‡ä»¶

## ğŸ“ æ—¥å¿—ç®¡ç†

PM2 ä¼šè‡ªåŠ¨åˆ›å»ºä»¥ä¸‹æ—¥å¿—æ–‡ä»¶ï¼š

```
logs/
â”œâ”€â”€ pm2-error.log      # é”™è¯¯æ—¥å¿—
â”œâ”€â”€ pm2-out.log        # æ ‡å‡†è¾“å‡º
â”œâ”€â”€ pm2-combined.log   # åˆå¹¶æ—¥å¿—
â””â”€â”€ ...                # è½®è½¬çš„å†å²æ—¥å¿—
```

**æ—¥å¿—ç‰¹æ€§**ï¼š

- JSON æ ¼å¼ä¾¿äºåˆ†æ
- è‡ªåŠ¨è½®è½¬ï¼ˆä¿ç•™ 10 ä¸ªæ–‡ä»¶ï¼‰
- æ—¶é—´æˆ³æ ¼å¼åŒ–
- åˆå¹¶å¤šè¿›ç¨‹æ—¥å¿—

## ğŸ› ï¸ ä½¿ç”¨å‘½ä»¤

### åŸºæœ¬æ“ä½œ

```bash
# å¯åŠ¨æœåŠ¡
npm run pm2:start

# åœæ­¢æœåŠ¡
npm run pm2:stop

# é‡å¯æœåŠ¡ï¼ˆé›¶åœæœºï¼‰
npm run pm2:restart

# åˆ é™¤æœåŠ¡
npm run pm2:delete

# æŸ¥çœ‹æ—¥å¿—
npm run pm2:logs

# ç›‘æ§é¢æ¿
npm run pm2:monit
```

### é«˜çº§æ“ä½œ

```bash
# é‡è½½é…ç½®ï¼ˆé›¶åœæœºï¼‰
pm2 reload ecosystem.config.js

# æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
pm2 show smart-match-api

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs smart-match-api --lines 50

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
pm2 monit

# ä¿å­˜PM2è¿›ç¨‹åˆ—è¡¨
pm2 save

# å¼€æœºè‡ªå¯åŠ¨
pm2 startup
pm2 save
```

## âš™ï¸ é…ç½®è¯´æ˜

### æ ¸å¿ƒé…ç½®

```javascript
{
  instances: "max",           // ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒ
  exec_mode: "cluster",       // é›†ç¾¤æ¨¡å¼
  max_memory_restart: "2G",   // å†…å­˜é™åˆ¶
  NODE_ENV: "production",     // ç”Ÿäº§ç¯å¢ƒ
  PORT: 8080                  // æœåŠ¡ç«¯å£
}
```

### æ€§èƒ½å‚æ•°

```javascript
node_args: [
  "--max-old-space-size=1536", // 1.5GBå†…å­˜é™åˆ¶
  "--optimize-for-size", // ä¼˜åŒ–å†…å­˜ä½¿ç”¨
  "--max-http-header-size=8192", // HTTPå¤´é™åˆ¶
  "--gc-interval=200", // GCé¢‘ç‡
]
```

### é‡å¯ç­–ç•¥

```javascript
{
  max_restarts: 15,              // æœ€å¤§é‡å¯æ¬¡æ•°
  min_uptime: "30s",             // æœ€å°è¿è¡Œæ—¶é—´
  exp_backoff_restart_delay: 100, // æŒ‡æ•°é€€é¿
  restart_delay: 1000            // é‡å¯å»¶è¿Ÿ
}
```

## ğŸ”§ ç¯å¢ƒå˜é‡

å¯ä»¥é€šè¿‡ `.env` æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡è¦†ç›–é»˜è®¤é…ç½®ï¼š

```env
NODE_ENV=production
PORT=8080
MONGODB_URI=mongodb://localhost:27017/smartmatch
JWT_SECRET=your-production-secret
LOG_LEVEL=info
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

- **CPU ä½¿ç”¨ç‡**: åº”ä¿æŒåœ¨ 70%ä»¥ä¸‹
- **å†…å­˜ä½¿ç”¨**: ä¸è¶…è¿‡ 2GB é™åˆ¶
- **é‡å¯æ¬¡æ•°**: é¢‘ç¹é‡å¯éœ€è¦è°ƒæŸ¥
- **å“åº”æ—¶é—´**: é€šè¿‡æ—¥å¿—åˆ†æ

### ç›‘æ§å‘½ä»¤

```bash
# å®æ—¶ç›‘æ§
pm2 monit

# çŠ¶æ€æ¦‚è§ˆ
pm2 status

# è¯¦ç»†ä¿¡æ¯
pm2 show smart-match-api

# æ—¥å¿—åˆ†æ
pm2 logs smart-match-api | grep "ERROR"
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **æœåŠ¡æ— æ³•å¯åŠ¨**

   ```bash
   # æ£€æŸ¥æ—¥å¿—
   pm2 logs smart-match-api --err

   # æ£€æŸ¥ç«¯å£å ç”¨
   netstat -tulpn | grep :8080
   ```

2. **å†…å­˜æ³„æ¼**

   ```bash
   # ç›‘æ§å†…å­˜ä½¿ç”¨
   pm2 monit

   # å¼ºåˆ¶é‡å¯
   pm2 restart smart-match-api
   ```

3. **é¢‘ç¹é‡å¯**

   ```bash
   # æŸ¥çœ‹é‡å¯å†å²
   pm2 show smart-match-api

   # æ£€æŸ¥é”™è¯¯æ—¥å¿—
   pm2 logs smart-match-api --err --lines 100
   ```

### æ€§èƒ½è°ƒä¼˜

1. **è°ƒæ•´å®ä¾‹æ•°é‡**

   ```javascript
   instances: 4,  // å›ºå®š4ä¸ªå®ä¾‹è€Œä¸æ˜¯"max"
   ```

2. **è°ƒæ•´å†…å­˜é™åˆ¶**

   ```javascript
   max_memory_restart: "1G",  // é™ä½åˆ°1GB
   ```

3. **è°ƒæ•´ GC å‚æ•°**
   ```javascript
   node_args: ["--max-old-space-size=1024", "--gc-interval=100"]
   ```

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### æ ‡å‡†æ›´æ–°æµç¨‹

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. å®‰è£…ä¾èµ–
npm install

# 3. è¿è¡Œæ¸…ç†
npm run cleanup

# 4. é›¶åœæœºé‡å¯
pm2 reload ecosystem.config.js
```

### å›æ»šæµç¨‹

```bash
# 1. å›é€€ä»£ç 
git checkout <previous-commit>

# 2. é‡å¯æœåŠ¡
pm2 restart smart-match-api
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **å®šæœŸç›‘æ§**: æ¯å¤©æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œæ—¥å¿—
2. **åŠæ—¶æ›´æ–°**: å®šæœŸæ›´æ–°ä¾èµ–å’Œå®‰å…¨è¡¥ä¸
3. **å¤‡ä»½é…ç½®**: å°† PM2 è¿›ç¨‹åˆ—è¡¨ä¿å­˜åˆ°æ–‡ä»¶
4. **ç›‘æ§å‘Šè­¦**: è®¾ç½®å†…å­˜å’Œ CPU ä½¿ç”¨ç‡å‘Šè­¦
5. **æ—¥å¿—åˆ†æ**: å®šæœŸåˆ†æé”™è¯¯æ—¥å¿—å’Œæ€§èƒ½æŒ‡æ ‡

## ğŸ“ˆ æ‰©å±•é…ç½®

å¦‚éœ€è¦æ›´å¤šå®ä¾‹æˆ–ç‰¹æ®Šé…ç½®ï¼Œå¯ä»¥ä¿®æ”¹ `ecosystem.config.js`ï¼š

```javascript
// å¤šåº”ç”¨é…ç½®ç¤ºä¾‹
module.exports = {
  apps: [
    {
      name: "smart-match-api",
      // ... ä¸»åº”ç”¨é…ç½®
    },
    {
      name: "smart-match-worker",
      script: "src/worker.js",
      instances: 2,
      // ... å·¥ä½œè¿›ç¨‹é…ç½®
    },
  ],
}
```

é€šè¿‡åˆç†é…ç½®å’Œç›‘æ§ï¼ŒPM2 å¯ä»¥ç¡®ä¿æ‚¨çš„æ™ºèƒ½å•†å“åŒ¹é…ç³»ç»Ÿåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç¨³å®šã€é«˜æ•ˆåœ°è¿è¡Œã€‚
